# PHP

## 通用的代码审计思路

### 逆向回溯变量

从危险函数的传入参数向上检查,回溯变量,检查变量是否经过过滤安全函数,定向挖掘某一类漏洞,对通读代码比较少,没有代码审计经验的本人最合适高效

### 正向跟踪变量

可以先了解程序的主要功能点,利用爬虫找到那些文件从外部接受参数,然后跟踪这些参数,在跟踪参数的过程中可以检查是否经过过滤函数,以及是否存在逻辑上的漏洞,说起来多么容易,haha

## 记录备忘

### PHP5和PHP7

PHP5在2018年底停止更新,最后的版本为5.6,在php7中改进的点:

- 移除了preg_replace中容易导致代码执行的e模式
- accert从函数转换为语法结构,和eval类似,不能再动态调用
- 7.2中移除create_function
- 移除不支持预编译sql查询语句的mysql拓展
- hex字符串不再作为数字

```php
var_dump('0x1' == 1);
var_dump(is_numeric('0x1'));

//php7后输出为false
//php5.6.4前输出都为true
```

### session

#### php.ini session配置项

- serializer handlers
  - php_serialize: 经过 serialize() 函数反序列处理的数组
  - php 键名 ＋ 竖线 ＋ 经过 serialize() 函数反序列处理的值
  - php_binary: 键名的长度对应的 ASCII 字符 ＋ 键名 ＋ 经过 serialize() 函数反序列处理的值
  - wddx

```php
session_start([
 'serialize_handler'=>'php', //==> name|s:4:"nana";id|i:11011;
 'serialize_handler'=>'php_serialize',// ==> a:2:{s:4:"name";s:4:"nana";s:2:"id";i:11011;}
 'serialize_handler'=>'php_binary',
]);
$_SESSION['name'] = 'nana';
$_SESSION['id'] = 11011;

session_write_close();

$s = file_get_contents('/var/lib/php/sessions/sess_'.session_id());
echo($s);
```

- session.save_path 默认/tmp, debian/ubuntu下为var/lib/php5/sessions或/var/lib/php/sessions
- session.auto_start 为on时,自动初始化session,不需要手动session_start
- session.upload_progress 在上传大文件是会采用流式传输,会将上传进度信息放在session中传递,且包含用户可控的值,默认开启,自动开启session
  - session.upload_progress.cleanup 上传完毕清除session文件
  - session.upload_progress.name PHP_SESSION_UPLOAD_PROGRESS
  - php会将PHP_SESSION_UPLOAD_PROGRESS的值做为session的键名,这个值可控,值为一个存储正在上传文件相关信息的数组,其中filename可控

> 在设置和读取session是会导致任意对象注入漏洞,
> 在5.6.13版本之前,php在解析session字符串时会根据 | 来分割字符串将左边的字符串做反序列化操作

