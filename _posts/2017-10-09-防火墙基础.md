## 防火墙基础

### 实验目的

- 掌握防火墙基础知识以及应用场景

### 实验环境

- 操作机：windows7

### 实验工具

- HCL_V2.1.0 H3C模拟器


**HCL**:华三云实验室（H3C Cloud Lab，简称HCL）是一款界面图形化的全真网络模拟软件，用户可以通过该软件实现H3C公司多个型号的虚拟设备的组网，是用户学习、测试基于H3C公司Comware V7平台的网络设备的必备工具。

### 实验内容

---

我们首先来了解一下防火墙的基本知识

**防火墙的基本介绍**

1.防火墙的定义

防火墙（Firewall）是指在本地网络与外界网络之间的一道防御系统，是这一类防范措施总称。防火墙是在两个网络通信时执行的一种访问控制尺度，它能允许“被同意”的人和数据进入你的网络，同时将“不被同意”的人和数据拒之门外，最大限度地阻止网络中的黑客来访问你的网络。互联网上的防火墙是一种非常有效的网络安全模型，通过它可以使企业内部局域网与Internet之间或者与其他外部网络互相隔离、限制网络互访，从而达到保护内部网络目的。

2.防火墙类型

- 2.1 从防火墙的软、硬件形式来分的话，防火墙可以分为软件防火墙和硬件防火墙以及芯片级防火墙。 

软件防火墙：软件防火墙运行于特定的计算机上，它需要客户预先安装好的计算机操作系统的支持，一般来说这台计算机就是整个网络的网关。俗称“个人防火墙”。软件防火墙就像其它的软件产品一样需要先在计算机上安装并做好配置才可以使用。


硬件防火墙:硬件防火墙基于硬件平台的网络防预系统，与芯片级防火墙相比并不需要专门的硬件。目前市场上大多数防火墙都是这种硬件防火墙，他们基于PC架构。

芯片级防火墙:芯片级防火墙基于专门的硬件平台，没有操作系统。专有的ASIC芯片促使它们比其他种类的防火墙速度更快，处理能力更强，性能更高。例如NetScreen、FortiNet、Cisco等。这类防火墙由于是专用OS（操作系统），防火墙本身的漏洞比较少，不过价格相对比较高昂。

- 2.2 从防火墙的技术来分的话，防火墙可以分为包过滤型、应用代理型.

包过滤（Packet filtering）型:包过滤型防火墙工作在OSI网络参考模型的网络层和传输层，它根据数据包头源地址，目的地址、端口号和协议类型等标志确定是否允许通过。只有满足过滤条件的数据包才被转发到相应的目的地，其余数据包则从数据流中被丢弃。

应用代理（Application Proxy）型:应用代理型防火墙是工作在OSI的最高层，即应用层。其特点是完全“阻隔”了网络通信流，通过对每种应用服务编制专门的代理程序，实现监视和控制应用层通信流的作用。目前防火墙已经在Internet上得到了广泛的应用。但是，防火墙并不能解决所有的网络安全问题，而只是网络安全政策和策略中的一个组成部分，但了解防火墙技术并学会在实际操作中应用防火墙技术，对于维护网络安全具有非常重要的意义。

**基本功能介绍**

我们这里以包过滤防火墙为例，因为包过滤防火墙是目前生产线上用的最多的，相对于其他类型防火墙，他价格便宜，转发速度快；当然安全性还是不能和应用代理防火墙相比，我们一起来看看包过滤型防火墙的基本功能；

- **分权分域**：防火墙中有安全域（zone）这样一个逻辑概念，通过接口加入域并在安全域之间启动安全检查，称为安全域间策略，从而对流经不通安全域的信息流进行安全过滤；防火墙预定义了几个安全域：本地区域Local（指防火墙本身）、受信任域Trust、非军事化区域DMZ、非受信任区域Untrust；用户可以根据自身网络需求添加新的安全域；

- **安全策略**：限制未经授权的用户访问本企业的网络和信息资源的措施，在安全域中调用起到域间过滤作用；

- **NAT**：提供ip地址转换和ip及tcp/udp端口映射，实现ip复用和隐藏网络结构：nat在ip层上通过地址转换提供ip复用功能，解决ip地址不足的问题，同时隐藏了内部网的结构，强化了内部网的安全。

- **高可靠性**：我们这里讲的高可靠性呢，是IRF；IRF（ Intelligent Resilient Framework，智能弹性架构）是 H3C 自主研发的软件虚拟化技术。它的核心思想是将多台设备连接在一起，进行必要的配置后，虚拟化成一台设备。使用这种虚拟化技术可以集合多台设备的硬件资源和软件处理能力，实现多台设备的协同工作、统一管理和不间断维护，保证网络系统安全可靠运行；


### 实验步骤

根据以上我们对防火墙的基本了解，我们一起来做一个实验巩固一下这些基本配置的基本应用场景；

如图：两台防火墙之间通过G0/23口互联，F1060-1的G0/0口与MSR36-20-3的G0/0口相连；F1060-1的G0/2口与MSR36-20-4的G0/0口相连；F1060-2的G0/0口与MSR36-20-3的G0/1口相连；F1060-2的G0/2口与MSR36-20-4口相连；

![](http://i.imgur.com/jEOBfZ9.jpg)

技术要求：

1. 两台防火墙之间必须提供高可靠性（IRF）保证网络的可靠运行；

2. MSR36-20-4模拟内网路由器，MSR36-20-3模拟外网路由器，根据此环境将相应接口划入安全域；

3. 内网路由器MSR36-20-4上创建2个回环口，loopback2 :2.2.2.2/32  ，用来模拟内网服务器地址；

4. 外网路由器MSR36-20-3上创建一个回环口loopback0:3.3.3.3/32 用来模拟外网服务器地址；
5. 防火墙与外网相连IP地址段为：222.246.129.0/24 ；防火墙与内网相连IP地址段为：192.168.1.0/24

6. 防火墙上对内网服务器做地址映射（NAT），要能使外网地址能访问到内网服务器地址；
7. 要求通过安全策略，使外网服务器只能ping通内网服务器地址2.2.2.2；其余服务一律拒绝；

一般情况下呢，以上要求都是从客户那调研得到的，（老铁就是扎心啊）；那么我们开始表演：

**步骤一：防火墙之间配置IRF，使两台防火墙上逻辑上成为一台设备**



- 在配置IRF端口之前，必须手动将两台防火墙互联端口G0/23端口shutdown，否则无法加入IRF端口；（注：防火墙默认登陆用户名：admin 密码：admin）
```
interface GigabitEthernet 1/0/23  	//进入接口视图
shutdown					  		 //关闭端口
```
![](http://i.imgur.com/LWqW8uJ.jpg)

- 配置IRF端口：

F1060-1配置：
```
irf-port 1/2				
//创建IRF端口，并进入IRF端口视图

port group interface GigabitEthernet 1/0/23 
//讲防火墙互联接口划入IRF端口

interface GigabitEthernet 1/0/23 			
//进入接口视图

undo shutdown					 	
//将之前关闭的端口开启

save								
//保存刚刚所做的配置

irf-port-configuration active 		
//激活刚刚我们对IRF端口所做的所有配置

```
![](http://i.imgur.com/l0MDESw.jpg)

调整F1060-1的IRF优先级，使其成为主设备：
```
irf member 1 priority 2	//调高F1060-1的IRF优先级，注意修改后激活IRF配置
```
![](http://i.imgur.com/CNHEAb6.jpg)

F1060-2配置：
```
irf member 1 renumber 2  
//修改F1060-2的成员编号，并重启后生效，重启前一定记得save保存配置；（注：系统询问是否继续时均选择“y”）
```
![](http://i.imgur.com/s5S0QTr.jpg)	

在配置IRF端口之前先关闭两台防火墙之间的互联接口G0/23口，（注：由于F1060-2修改了IRF成员编号，所以端口编号也跟着变了，所以我们这里需要注意）
```
interface GigabitEthernet 2/0/23  //进入接口视图
shutdown		//关闭端口
```
![](http://i.imgur.com/6BlrGx3.jpg)

配置F1060-2的IRF端口：
```
irf-port 2/1								
//进入IRF视图

port group interface GigabitEthernet 2/0/23 
//绑定物理端口到IRF端口

interface GigabitEthernet 2/0/23  			
//进入接口视图

undo shutdown								
//开启端口

save										
//保存配置

irf-port-configuration active				
//激活IRF配置

```
![](http://i.imgur.com/OxEZ5hD.jpg)

此时，两台防火墙设备就虚拟成一台逻辑的防火墙，只要在主防火墙上做相关配置，那么备用防火墙上会同步这一配置，我们可以做个简单的小实验，在原F1060-1上我们更改防火墙的主机名，那么F1060-2的主机名也会变成一样，前提是需要保存配置才能完成同步；如图：
```
sysname H3C-FW	//修改F1060-1的主机名为H3C-FW
```
![](http://i.imgur.com/DIb1vQZ.jpg)

![](http://i.imgur.com/75KbYZP.jpg)

**步骤二：配置防火墙接口IP地址**

- 配置防火墙接口IP地址（注：由于做了IRF，两台设备变成一台，查看接口状态的时候，可以看到两台设备所有的接口都会展现出来，所以接口编号会有所改变，接口G“G1/x/x”中的1代表原来的F1060-1；接口“G2/X/X”代表这原来的F1060-2）
```
interface Route-Aggregation 1	//创建三层聚合接口，编号为1
ip address 222.246.129.1 24	//配置外网口IP地址

interface GigabitEthernet 1/0/0	//进入接口视图
port link-aggregation group 1	//将接口与三层聚合口绑定

interface GigabitEthernet 2/0/0	//进入接口视图
port link-aggregation group 1	//将接口与三层聚合口绑定
```
![](http://i.imgur.com/VzVK2w7.jpg)
```
interface Route-Aggregation 2	//创建三层聚合接口，编号为2
ip address 192.168.1.1 24	//配置内网口IP地址

interface GigabitEthernet 1/0/2	//进入接口视图
port link-aggregation group 2	//将接口与三层聚合口绑定

interface GigabitEthernet 2/0/2	//进入接口视图
port link-aggregation group 2	//将接口与三层聚合口绑定
```
![](http://i.imgur.com/88ovTo2.jpg)

**步骤三：配置路由器MSR36-20-3的接口IP地址**
```
sysname MSR36-20_3	//修改设备主机名

interface Route-Aggregation 1	//创建三层聚合接口，编号为1
ip add 222.246.129.2 24	//配置外网口IP地址

interface GigabitEthernet 0/0		//进入接口视图
port link-aggregation group 1	//将接口与三层聚合口绑定

interface GigabitEthernet 0/1		//进入接口视图
port link-aggregation group 1	//将接口与三层聚合口绑定
```
![](http://i.imgur.com/PWfPTVD.jpg)

配置loopback0接口IP，模拟公网服务器：
```
interface LoopBack 0		//创建loopback 0口
ip address 3.3.3.3 255.255.255.255	//配置接口IP
```
![](http://i.imgur.com/6MxAvkG.jpg)

**步骤四：配置路由器MSR36-20-4的接口IP地址**
```
sysname MSR36-20_4	//修改设备主机名

interface Route-Aggregation 2	//创建三层聚合接口，编号为1
ip add 192.168.1.2 24	//配置外网口IP地址

interface GigabitEthernet 0/0		//进入接口视图
port link-aggregation group 2	//将接口与三层聚合口绑定

interface GigabitEthernet 0/1		//进入接口视图
port link-aggregation group 2	//将接口与三层聚合口绑定
```
![](http://i.imgur.com/ATrni1w.jpg)

配置loopback2口，模拟内网服务器：
```
interface LoopBack 2		//创建loopback 2口
ip address 2.2.2.2 255.255.255.255	//配置接口IP
```
![](http://i.imgur.com/4h5eLs8.jpg)

**步骤五：防火墙上将相应接口划入安全域**
```
    security-zone name Trust		//进入Trust接口视图
		import interface g1/0/2		//将F1060-1下行接口，G1/0/2添加进Trust安全域
		import interface g2/0/2		//将F1060-2下行接口，G2/0/2添加进Trust安全域
		import interface Route-Aggregation2	//将三层聚合口添加进Trust安全域

    security-zone name Untrust		//进入Trust接口视图
		import interface g1/0/0		//将F1060-1上行接口，G1/0/0添加进Untrust安全域
		import interface g2/0/0		//将F1060-2上行接口，G2/0/0添加进Untrust安全域
		import interface Route-Aggregation1	//将三层聚合口添加进Untrust安全域
```
![](http://i.imgur.com/NzgRHNv.jpg)

**步骤六：防火墙上配置NAT地址转化**
```
nat static outbound 2.2.2.2 222.246.129.4	
//将内网ip:2.2.2.2映射成公网IP：222.246.129.4（注：需要注意的是，我们这里映射出去的公网IP需要和出接口IP在同一个网段）

interface Route-Aggregation 1	
//进入三层聚合口视图

nat static enable	
//开启静态nat转化功能
```
![](http://i.imgur.com/5TItPje.jpg)

**步骤七：配置相关安全策略**

我们首先需要根据需求，将公网到内网部分流量放行：要求通过安全策略，使外网服务器只能ping通内网服务器地址2.2.2.2；其余服务一律拒绝
```
acl advanced 3000		
//创建扩展ACL，编号为3000，用户过滤Untrust到Trust域之间的流量

rule 10 permit icmp source 3.3.3.3 0 destination 2.2.2.2 0 	
//只允许外网服务器ping访问内网2.2.2.2

rule 15 permit ip source 222.246.129.0 0.0.0.255
//放通直连网段

rule 1000 deny ip		
//拒绝其他所有流量

acl advanced 3001		
//创建扩展ACL，编号3001，用户Trust到Untrust域之间放行策略

rule 5 permit ip 	
//允许所有流量

zone-pair security source trust destination untrust	
//创建Trust域到Untrust域间实例，用来调用安全策略
		
packet-filter 3001		
//调用安全策略3001，放行内网到外网所有流量

zone-pair security source untrust destination trust
//创建Untrust域到Trust域间实例，用来调用安全策略

packet-filter 3000		
//调用安全策略3000，放行外网部分流量，以满足需求
```
![](http://i.imgur.com/fMPZeII.jpg)

（注：记得save保存配置，用于主备防火墙同步配置）

**步骤八：相关设备上配置路由，使全网可达**

防火墙上配置默认出口路由，以及到达内网服务器2.2.2.2 的主机路由：
```
ip route-static 0.0.0.0 0.0.0.0 222.246.129.2	//配置默认路由，使其可以到达公网任何地方

ip route-static 2.2.2.2 255.255.255.255 192.168.1.2	//配置对内网的主机路由
```
![](http://i.imgur.com/vlLSfEC.jpg)

MSR36-20-4上配置出口默认路由：
```
ip route-static 0.0.0.0 0.0.0.0 192.168.1.1	//配置默认路由，使其可以访问任何地方
```
![](http://i.imgur.com/4R87qAa.jpg)

**步骤九：测试业务需求**

在MSR36-20-3上带源ping测试内网服务器映射地址，可以看到，ping测试通过，表明NAT映射生效，以及安全策略也是生效的：

![](http://i.imgur.com/jbVD23x.jpg)

### 实验结果分析与总结

通过这个实验，我们可以比较系统的掌握防火墙的NAT，安全策略，安全域，以及我们的重点高可靠性的知识；其实往往在现网结构中，防火墙的策略部署会比这复杂得多，还需要各位多加研究；

### 思考


1. 有的同学发现，防火墙静态映射一个内网IP对于一个公网IP，压根没有起到节约公网IP地址的作用，那么还请各位童鞋思考，防火墙NAT映射还有哪些实现方法；
2. 本实验的高可靠性是通过IRF来实现的，那么请思考，还有那种方法可以实现防火墙的双机热备


### 题目

1. 防火墙的工作模式有路由器模式、透明模式和混杂模式三种？
对

2. 常见防火墙按照采用的技术分类主要有：包过滤防火墙和代理防火墙？
对